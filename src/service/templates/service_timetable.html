{% extends 'service_base.html' %}

{% load utils_extra_filters %}

{% block additional_info %}
        <p>
            <b>Что&nbsp;значат&nbsp;цвета?</b>
        </p>
        <p class='card-maintext'>
            <span class='preview'></span> - Этот интервал можно выбирать<br />
            <span class='preview ended'></span> - Этот интервал уже нельзя выбирать<br />
            <span class='preview selected'></span> - Этот интервал был кем-то выбран<br />
            <span class='preview choisen'></span> - Этот интервал был выбран Вами<br />
            <span class='preview started'></span> - Ваш интервал уже идёт, но его пока ещё можно отменить (лимит - {{ service.time_after_now|util_get_min_time_str }})
        </p>
{% endblock %}

{% block form_attributes %}
    id='washing'
{% endblock %}

{% block day_attributes %}
    class='full-width'
{% endblock %}

{% block single_day %}
    <table class='table_aside'>
        <tr>
            <th>Время</th>
        </tr>
        {% for t in day.timetable %}
            <tr style='vertical-align:bottom;'>
                <td>{{ t.start|date:'H:i' }}</td>
            </tr>
            {% if forloop.last %}
                <tr style='vertical-align:bottom;'>
                    <td>{{ t.end|date:'H:i' }}</td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
    <!-- print machines -->
    <table class='table_main'>
        <tr>
            <td colspan={{ day.items.items|length }}>
                <table>
                    <tr>
                        {% for i_name,i_value in day.items.items %}
                        <th style='word-break:normal;vertical-align:top;'>{{ i_name }}<br /><small>({{ i_value.price }} руб.)</small></th>
                        {% endfor %}
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <!-- second 'items' on Python dict. is 'get pair of key and value'-->
            {% for i_name,i_value in day.items.items %}
                <td>
                    <table>
                        <!-- print cells -->
                        {% for cell in i_value.time %}
<!-- break trailing spaces for nicer appeal -->
<tr>
    {% if not cell.is_open or cell.is_open and cell.is_now and cell.start|util_is_finished:service %}
    <td style='padding:0;min-width:100px;max-width:100px;' class='ended' {% if cell.is_open %}rowspan='{{ i_value.rowspan }}'{% endif %}>
            {% if user.is_authenticated and cell.orders %}
                <label class='userinfo' for='modal_userinfo_check' onclick='show_orders({{ cell.orders|util_orders_to_json }});' title='Посмотреть инфо о заказавшем(-ей)'></label>
            {% endif %}
        </td>
    {% else %}
    <td style='padding:0;min-width:100px;max-width:100px;' rowspan='{{ i_value.rowspan }}' class={% if cell.orders and  cell.orders|util_is_current_user_order:user %}{% if cell.is_now %}'started'{% else %}'choisen'{% endif %}{% elif cell.orders %}'selected'{% endif %}>
            {% if cell.orders and user.is_authenticated and cell.orders|util_is_other_user_order:user %}
                <label class='userinfo' for='modal_userinfo_check' onclick='show_orders({{ cell.orders|util_orders_to_json }});' title='Посмотреть инфо о заказавшем(-ей)'></label>
            <!-- means 'not current user' -->
            {% elif not cell.orders %}
                <label>
                    <input type='checkbox' name='order={{ i_name }}&&{{ cell.start.time }}&&{{ cell.end.time }}&&{{ cell.start.date|date:'Y-m-d' }}' data-price='{{ i_value.price }}' data-timestart='{{ cell.start.time }}' data-timeend='{{ cell.end.time }}' data-item='{{ i_name }}' class='hidden'/>
                    <span><div>+</div></span>
                </label>
            {% elif cell.orders and cell.orders|util_is_current_user_order:user %}
                <label>
                    {% with order=cell.orders|first %}
                    <input type='checkbox' name='cancel={{ order.id }}' data-price='-{{ i_value.price }}' data-timestart='{{ cell.start.time }}' data-timeend='{{ cell.end.time }}' data-item='{{ i_name }}' class='hidden'/>
                        <span><div>-</div></span>
                    {% endwith %}
                </label>
            {% endif %}
        </td>
    {% endif %}
</tr>
    {% if cell.is_open %}
        {% with current_range=i_value.rowspan|util_range %}
        {% for i in current_range %}
            {% if not forloop.last %}
                <tr></tr>
            {% endif %}
        {% endfor %}
        {% endwith %}
    {% endif %}
<!-- break end -->
                        {% endfor %}
                    </table>
                </td>
            {% endfor %}
        </tr>
    </table>
{% endblock %}
